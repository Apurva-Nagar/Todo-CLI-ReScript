// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Fs = require("fs");
var Os = require("os");
var Curry = require("bs-platform/lib/js/curry.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Caml_array = require("bs-platform/lib/js/caml_array.js");
var Belt_Option = require("bs-platform/lib/js/belt_Option.js");

var encoding = "utf8";

var getToday = (function() {
  let date = new Date();
  return new Date(date.getTime() - (date.getTimezoneOffset() * 60000))
    .toISOString()
    .split("T")[0];
});

var pendingTodosFile = "todo.txt";

var completedTodosFile = "done.txt";

var helpString = "Usage :-\n$ ./todo add \"todo item\"  # Add a new todo\n$ ./todo ls               # Show remaining todos\n$ ./todo del NUMBER       # Delete a todo\n$ ./todo done NUMBER      # Complete a todo\n$ ./todo help             # Show usage\n$ ./todo report           # Statistics";

function readFile(filename) {
  if (!Fs.existsSync(filename)) {
    return [];
  }
  var text = Fs.readFileSync(filename, {
        encoding: encoding,
        flag: "r"
      });
  return text.split("\n");
}

function appendToFile(filename, text) {
  Fs.appendFileSync(filename, text, {
        encoding: encoding,
        flag: "a+"
      });
  
}

function writeFile(filename, lines) {
  var text = lines.join(Os.EOL);
  Fs.writeFileSync(filename, text, {
        encoding: encoding,
        flag: "w"
      });
  
}

function updateFile(filename, updaterFn) {
  var contents = readFile(filename);
  var updatedContent = Curry._1(updaterFn, contents);
  return writeFile(filename, updatedContent);
}

function cmdHelp(param) {
  console.log(helpString);
  
}

function cmdLs(param) {
  var todos = readFile(pendingTodosFile);
  var todosCount = todos.length;
  if (todosCount === 0) {
    console.log("There are no pending todos!");
    return ;
  }
  var formattedTodos = Belt_Array.reduceWithIndex(Belt_Array.reverse(todos), "", (function (acc, todo, index) {
          var todoIndex = todosCount - index | 0;
          return acc + ("[" + todoIndex + "] " + todo + "\n");
        }));
  console.log(formattedTodos);
  
}

function cmdAddTodo(text) {
  var cmdStatus = Belt_Option.mapWithDefault(text, "Error: Missing todo string. Nothing added!", (function (x) {
          updateFile(pendingTodosFile, (function (todos) {
                  return todos.concat([x]);
                }));
          return "Added todo: \"" + x + "\"";
        }));
  console.log(cmdStatus);
  
}

function cmdDelTodo(number) {
  var cmdStatus = Belt_Option.mapWithDefault(number, "Error: Missing NUMBER for deleting todo.", (function (x) {
          var todos = readFile(pendingTodosFile);
          if (x < 1 || x > todos.length) {
            return "Error: todo #" + x + " does not exist. Nothing deleted.";
          } else {
            updateFile(pendingTodosFile, (function (todos) {
                    todos.splice(x, 1);
                    return todos;
                  }));
            return "Deleted todo #" + number;
          }
        }));
  console.log(cmdStatus);
  
}

function cmdMarkDone(number) {
  var cmdStatus = Belt_Option.mapWithDefault(number, "Error: Missing NUMBER for marking todo as done.", (function (x) {
          var todos = readFile(pendingTodosFile);
          if (x < 1 || x > todos.length) {
            return "Error: todo #" + x + " does not exist.";
          }
          var completedTodo = todos.splice(x - 1 | 0, 1);
          writeFile(pendingTodosFile, todos);
          var completedTodoStr = "x " + Curry._1(getToday, undefined) + " " + Caml_array.get(completedTodo, 0) + "\n";
          appendToFile(completedTodosFile, completedTodoStr);
          return "Marked todo #" + x + " as done.";
        }));
  console.log(cmdStatus);
  
}

function cmdReport(param) {
  var pending = readFile(pendingTodosFile).length;
  var completed = readFile(completedTodosFile).length - 1 | 0;
  console.log(Curry._1(getToday, undefined) + " Pending : " + String(pending) + " Completed : " + String(completed));
  
}

function optionStringToOptionInteger(value) {
  return Number.parseInt(value);
}

var command = Belt_Array.get(process.argv, 2);

var arg = Belt_Array.get(process.argv, 3);

var commandType = Belt_Option.mapWithDefault(command, /* Help */0, (function (x) {
        switch (x) {
          case "add" :
              return {
                      TAG: /* Add */0,
                      _0: arg
                    };
          case "del" :
              var index = Belt_Option.flatMap(arg, optionStringToOptionInteger);
              return {
                      TAG: /* Delete */1,
                      _0: index
                    };
          case "done" :
              var index$1 = Belt_Option.flatMap(arg, optionStringToOptionInteger);
              return {
                      TAG: /* Done */2,
                      _0: index$1
                    };
          case "help" :
              return /* Help */0;
          case "ls" :
              return /* List */2;
          case "report" :
              return /* Report */1;
          default:
            return /* Help */0;
        }
      }));

if (typeof commandType === "number") {
  switch (commandType) {
    case /* Help */0 :
        console.log(helpString);
        break;
    case /* Report */1 :
        cmdReport(undefined);
        break;
    case /* List */2 :
        cmdLs(undefined);
        break;
    
  }
} else {
  switch (commandType.TAG | 0) {
    case /* Add */0 :
        cmdAddTodo(commandType._0);
        break;
    case /* Delete */1 :
        cmdDelTodo(commandType._0);
        break;
    case /* Done */2 :
        cmdMarkDone(commandType._0);
        break;
    
  }
}

exports.encoding = encoding;
exports.getToday = getToday;
exports.pendingTodosFile = pendingTodosFile;
exports.completedTodosFile = completedTodosFile;
exports.helpString = helpString;
exports.readFile = readFile;
exports.appendToFile = appendToFile;
exports.writeFile = writeFile;
exports.updateFile = updateFile;
exports.cmdHelp = cmdHelp;
exports.cmdLs = cmdLs;
exports.cmdAddTodo = cmdAddTodo;
exports.cmdDelTodo = cmdDelTodo;
exports.cmdMarkDone = cmdMarkDone;
exports.cmdReport = cmdReport;
exports.optionStringToOptionInteger = optionStringToOptionInteger;
exports.command = command;
exports.arg = arg;
exports.commandType = commandType;
/* command Not a pure module */
